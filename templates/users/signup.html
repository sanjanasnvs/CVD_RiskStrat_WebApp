{% extends 'base.html' %}

{% block title %}Create Patient Account - CVD Risk Predictor{% endblock %}

{% block content %}
<style>
  .signup-container {
    min-height: calc(100vh - 200px);
    padding: 2rem 0;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  }
  
  .signup-header {
    text-align: center;
    margin-bottom: 3rem;
  }
  
  .signup-header h1 {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #1977cc 0%, #0056b3 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
  }
  
  .signup-header p {
    font-size: 1.1rem;
    color: #6c757d;
    margin-bottom: 0;
  }
  
  .signup-card {
    background: white;
    border-radius: 24px;
    padding: 3rem;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.2);
    max-width: 700px;
    margin: 0 auto;
  }
  
  .patient-notice {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 2px solid #2196f3;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    text-align: center;
  }
  
  .patient-notice strong {
    color: #1565c0;
  }
  
  .patient-notice a {
    color: #1976d2;
    font-weight: 600;
    text-decoration: none;
  }
  
  .patient-notice a:hover {
    text-decoration: underline;
  }
  
  .form-group {
    margin-bottom: 1.5rem;
  }
  
  .form-label {
    font-weight: 600;
    color: #2c4964;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .form-control {
    border-radius: 12px;
    border: 2px solid #e9ecef;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: #f8f9fa;
  }
  
  .form-control:focus {
    border-color: #1977cc;
    box-shadow: 0 0 0 4px rgba(25, 119, 204, 0.1);
    outline: none;
    background: white;
    transform: translateY(-1px);
  }
  
  .form-control:hover {
    border-color: #1977cc;
    background: white;
  }
  
  .password-container {
    position: relative;
  }
  
  .password-toggle {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #6c757d;
    font-size: 1.1rem;
    transition: color 0.3s ease;
    z-index: 10;
  }
  
  .password-toggle:hover {
    color: #1977cc;
  }
  
  .password-requirements {
    margin-top: 0.75rem;
  }
  
  .requirement-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }
  
  .requirement-icon {
    width: 16px;
    height: 16px;
    margin-right: 0.75rem;
    font-size: 0.8rem;
    transition: all 0.3s ease;
  }
  
  .requirement-item.valid {
    color: #28a745;
  }
  
  .requirement-item.invalid {
    color: #dc3545;
  }
  
  .requirement-item.neutral {
    color: #6c757d;
  }
  
  .password-match-indicator {
    position: absolute;
    top: -2.5rem;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    text-align: center;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
    z-index: 20;
  }
  
  .password-match-indicator.show {
    opacity: 1;
    transform: translateY(0);
  }
  
  .submit-btn {
    background: linear-gradient(135deg, #1977cc 0%, #0056b3 100%);
    border: none;
    border-radius: 12px;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 700;
    color: white;
    width: 100%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 16px rgba(25, 119, 204, 0.25);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(25, 119, 204, 0.35);
  }
  
  .submit-btn:active {
    transform: translateY(0);
  }
  
  .error-alert {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    border: 2px solid #dc3545;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .error-alert ul {
    margin-bottom: 0;
    padding-left: 1.5rem;
  }
  
  .error-alert li {
    margin-bottom: 0.5rem;
    color: #721c24;
    font-weight: 600;
  }
  
  .login-link {
    text-align: center;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid #e9ecef;
  }
  
  .login-link a {
    color: #1977cc;
    font-weight: 600;
    text-decoration: none;
    transition: color 0.3s ease;
  }
  
  .login-link a:hover {
    color: #0056b3;
    text-decoration: underline;
  }
  
  @media (max-width: 768px) {
    .signup-card {
      padding: 2rem 1.5rem;
      margin: 0 1rem;
    }
    
    .signup-header h1 {
      font-size: 2rem;
    }
    
    .row {
      margin: 0;
    }
    
    .col-md-6 {
      padding: 0;
      margin-bottom: 1rem;
    }
  }
  
  /* Form validation animations */
  .form-control.is-valid {
    border-color: #28a745;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.94-.94 1.38 1.38 3.68-3.68.94.94-4.62 
4.62z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
  }
  
  .form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' 
r='4.5'/%3e%3cpath d='m5.8 4.6 1.4 1.4 1.4-1.4M8.6 7.4 7.2 6 5.8 7.4'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
  }
</style>

<section class="signup-container">
  <div class="container">
    
    <!-- Header -->
    <div class="signup-header">
      <h1>Create Patient Account</h1>
      <p>Join our cardiovascular risk assessment platform</p>
    </div>
    
    <!-- Signup Card -->
    <div class="signup-card">
      
      <!-- Patient Notice -->
      <div class="patient-notice">
        <i class="bi bi-info-circle me-2" style="font-size: 1.2rem;"></i>
        <strong>For patients only.</strong> If you are a clinician, please use the 
        <a href="{% url 'request_access' %}">Request Access</a> form.
      </div>
      
      <!-- Signup Form -->
      <form method="post" id="signup-form" novalidate>
        {% csrf_token %}
        
        <!-- Name Fields -->
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="id_first_name" class="form-label">First Name</label>
              <input type="text" 
                     name="first_name" 
                     class="form-control" 
                     id="id_first_name" 
                     placeholder="Enter your first name" 
                     value="{{ form.first_name.value|default:'' }}"
                     required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="id_last_name" class="form-label">Last Name</label>
              <input type="text" 
                     name="last_name" 
                     class="form-control" 
                     id="id_last_name" 
                     placeholder="Enter your last name" 
                     value="{{ form.last_name.value|default:'' }}"
                     required>
            </div>
          </div>
        </div>
        
        <!-- Sex and Clinician Fields -->
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="id_sex" class="form-label">Biological Sex</label>
              <select name="sex" class="form-control" id="id_sex" required>
                <option value="">Select your biological sex...</option>
                <option value="Male" {% if form.sex.value == 'Male' %}selected{% endif %}>Male</option>
                <option value="Female" {% if form.sex.value == 'Female' %}selected{% endif %}>Female</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="id_clinician" class="form-label">Requesting Doctor</label>
              <select name="clinician" class="form-control" id="id_clinician">
                <option value="">Select your doctor...</option>
                {% for clinician in clinicians %}
                  <option value="{{ clinician.clinician_id }}">
                    Dr. {{ clinician.user.first_name }} {{ clinician.user.last_name }}
                  </option>
                {% endfor %}
                <option value="none">My doctor is not listed / I don't have a doctor yet</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Email Field -->
        <div class="form-group">
          <label for="id_email" class="form-label">Email Address</label>
          <input type="email" 
                 name="email" 
                 class="form-control" 
                 id="id_email" 
                 placeholder="Enter your email address" 
                 value="{{ form.email.value|default:'' }}"
                 required>
        </div>
        
        <!-- Password Fields -->
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="id_password1" class="form-label">Password</label>
              <div class="password-container">
                <input type="password" 
                       name="password1" 
                       class="form-control" 
                       id="id_password1" 
                       placeholder="Create a strong password"
                       required>
                <i class="bi bi-eye password-toggle" id="togglePassword1"></i>
              </div>
              <div class="password-requirements">
                <div class="requirement-item neutral" id="length">
                  <i class="bi bi-circle-fill requirement-icon"></i>
                  <span>At least 8 characters</span>
                </div>
                <div class="requirement-item neutral" id="case">
                  <i class="bi bi-circle-fill requirement-icon"></i>
                  <span>Contains both uppercase and lowercase letters</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="id_password2" class="form-label">Confirm Password</label>
              <div class="password-container">
                <input type="password" 
                       name="password2" 
                       class="form-control" 
                       id="id_password2" 
                       placeholder="Confirm your password"
                       required>
                <i class="bi bi-eye password-toggle" id="togglePassword2"></i>
                <div class="password-match-indicator" id="passwordMatchIndicator">
                  Passwords do not match
                </div>
              </div>
              <div class="password-requirements">
                <div class="requirement-item neutral" id="numeric">
                  <i class="bi bi-circle-fill requirement-icon"></i>
                  <span>Cannot be entirely numeric</span>
                </div>
                <div class="requirement-item neutral" id="special">
                  <i class="bi bi-circle-fill requirement-icon"></i>
                  <span>Includes at least one special character (!@#$%^&*)</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Error Messages -->
        {% if form.errors %}
          <div class="error-alert">
            <h6><i class="bi bi-exclamation-triangle me-2"></i>Please correct the following errors:</h6>
            <ul>
              {% for field in form %}
                {% for error in field.errors %}
                  <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                {% endfor %}
              {% endfor %}
              {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        
        <!-- Submit Button -->
        <button type="submit" class="submit-btn">
          <i class="bi bi-person-plus me-2"></i>
          Create Account
        </button>
        
      </form>
      
      <!-- Login Link -->
      <div class="login-link">
        <p>Already have an account? <a href="{% url 'login' %}">Sign in here</a></p>
      </div>
      
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Password toggle functionality
  const togglePassword1 = document.getElementById('togglePassword1');
  const passwordInput1 = document.getElementById('id_password1');
  const togglePassword2 = document.getElementById('togglePassword2');
  const passwordInput2 = document.getElementById('id_password2');
  const passwordMatchIndicator = document.getElementById('passwordMatchIndicator');

  // Toggle password visibility
  function setupPasswordToggle(toggle, input) {
    if (toggle && input) {
      toggle.addEventListener('click', function() {
        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);
        this.classList.toggle('bi-eye');
        this.classList.toggle('bi-eye-slash');
      });
    }
  }

  setupPasswordToggle(togglePassword1, passwordInput1);
  setupPasswordToggle(togglePassword2, passwordInput2);

  // Password validation
  if (passwordInput1 && passwordInput2) {
    passwordInput1.addEventListener('input', validatePassword);
    passwordInput2.addEventListener('input', validatePasswordMatch);
  }

  function validatePassword() {
    const password = passwordInput1.value;
    const isEmpty = password.length === 0;

    // Length requirement
    const lengthReq = document.getElementById('length');
    updateRequirement(lengthReq, password.length >= 8, isEmpty);

    // Case requirement
    const caseReq = document.getElementById('case');
    const hasUpper = /[A-Z]/.test(password);
    const hasLower = /[a-z]/.test(password);
    updateRequirement(caseReq, hasUpper && hasLower, isEmpty);

    // Numeric requirement
    const numericReq = document.getElementById('numeric');
    const isNotAllNumeric = password.length > 0 && !/^[0-9]+$/.test(password);
    updateRequirement(numericReq, isNotAllNumeric, isEmpty);

    // Special character requirement
    const specialReq = document.getElementById('special');
    const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
    updateRequirement(specialReq, hasSpecial, isEmpty);

    // Validate password match when password changes
    validatePasswordMatch();
  }

  function validatePasswordMatch() {
    const password = passwordInput1.value;
    const confirmPassword = passwordInput2.value;

    if (confirmPassword.length > 0 && password !== confirmPassword) {
      passwordMatchIndicator.classList.add('show');
      passwordInput2.classList.add('is-invalid');
      passwordInput2.classList.remove('is-valid');
    } else if (confirmPassword.length > 0 && password === confirmPassword) {
      passwordMatchIndicator.classList.remove('show');
      passwordInput2.classList.remove('is-invalid');
      passwordInput2.classList.add('is-valid');
    } else {
      passwordMatchIndicator.classList.remove('show');
      passwordInput2.classList.remove('is-invalid', 'is-valid');
    }
  }

  function updateRequirement(element, isMet, isEmpty) {
    const icon = element.querySelector('.requirement-icon');
    
    if (isEmpty) {
      element.className = 'requirement-item neutral';
      icon.className = 'bi bi-circle-fill requirement-icon';
    } else if (isMet) {
      element.className = 'requirement-item valid';
      icon.className = 'bi bi-check-circle-fill requirement-icon';
    } else {
      element.className = 'requirement-item invalid';
      icon.className = 'bi bi-x-circle-fill requirement-icon';
    }
  }

  // Form validation on submit
  const form = document.getElementById('signup-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      const password = passwordInput1.value;
      const confirmPassword = passwordInput2.value;
      
      if (password !== confirmPassword) {
        e.preventDefault();
        passwordMatchIndicator.classList.add('show');
        passwordInput2.focus();
        return false;
      }
      
      return true;
    });
  }

  // Real-time form validation
  const inputs = document.querySelectorAll('input[required], select[required]');
  inputs.forEach(input => {
    input.addEventListener('blur', function() {
      if (this.value.trim() === '') {
        this.classList.add('is-invalid');
        this.classList.remove('is-valid');
      } else {
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
      }
    });

    input.addEventListener('input', function() {
      if (this.classList.contains('is-invalid') && this.value.trim() !== '') {
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
      }
    });
  });
});
</script>
{% endblock %}
