{% extends 'base.html' %}

{% block content %}
<style>
  .password-match-indicator {
    display: none;
    position: absolute;
    left: 0;
    bottom: calc(100% + 5px);
    background-color: #f8d7da;
    color: #721c24;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    z-index: 110;
    white-space: nowrap;
  }
  .password-match-indicator.show {
    display: block;
  }
</style>
<div class="container mt-5 mb-5">
  <div class="row mb-4">
    <div class="col-md-4">
      <h1 class="text-primary">Create Patient Account</h1>
    </div>
  </div>
  <div class="row justify-content-center">
    <div class="col-md-7">
      <div class="card shadow p-4 w-100" style="max-width: 650px;">
        <div class="alert alert-info text-center mb-3">
          For <strong>patients only</strong>. If you are a clinician, please use the <a href="{% url 'request_access' %}">Request Access</a> form.
        </div>
        <form method="post" id="signup-form" novalidate>
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="id_first_name" class="form-label">First Name</label>
              <input type="text" name="first_name" class="form-control" id="id_first_name" placeholder="First Name" value="{{ form.first_name.value|default:'' }}">
            </div>
             <div class="col-md-6 mb-3">
              <label for="id_last_name" class="form-label">Last Name</label>
              <input type="text" name="last_name" class="form-control" id="id_last_name" placeholder="Last Name" value="{{ form.last_name.value|default:'' }}">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="id_biological_sex" class="form-label">Biological Sex</label>
              <select name="biological_sex" class="form-control" id="id_biological_sex">
                <option value="">Select...</option>
                <option value="Male" {% if form.biological_sex.value == 'Male' %}selected{% endif %}>Male</option>
                <option value="Female" {% if form.biological_sex.value == 'Female' %}selected{% endif %}>Female</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="id_clinician" class="form-label">Requesting Doctor</label>
              <select name="clinician" class="form-control" id="id_clinician_id">
                <option value="">Select a doctor...</option>
                {% for clinician in clinicians %}
                  <option value="{{ clinician.clinician_id }}">Dr. {{ clinician.user.first_name }} {{ clinician.user.last_name }}</option>
                {% endfor %}
                <option value="none">My doctor is not listed / I don't have a doctor yet</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="id_email" class="form-label">Email Address</label>
              <input type="email" name="email" class="form-control" id="id_email" placeholder="Email Address" value="{{ form.email.value|default:'' }}">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="id_password1" class="form-label">Password</label>
              <div class="input-group" style="position: relative;">
                <input type="password" name="password1" class="form-control" id="id_password1" placeholder="Password">
                 <span class="input-group-text" id="togglePassword1" style="cursor: pointer; position: absolute; right: 0; top: 0; bottom: 0; z-index: 100; background-color: transparent; border: none;">
                  <i class="bi bi-eye"></i>
                </span>
              </div>
               <small class="form-text mt-1">
                <ul class="list-unstyled">
                  <li id="length" class="text-secondary mb-1"><i class="bi bi-circle-fill me-2" style="font-size: 0.7em;"></i>At least 8 characters</li>
                  <li id="common" class="text-secondary mb-1 d-flex align-items-start"><i class="bi bi-circle-fill me-2" style="font-size: 0.7em;"></i><span>Contains both uppercase and lowercase characters.</span></li>
                </ul>
              </small>
            </div>
            <div class="col-md-6 mb-3">
              <label for="id_password2" class="form-label">Confirm Password</label>
              <div class="input-group" style="position: relative;">
                 <input type="password" name="password2" class="form-control" id="id_password2" placeholder="Confirm Password">
                  <span class="input-group-text" id="togglePassword2" style="cursor: pointer; position: absolute; right: 0; top: 0; bottom: 0; z-index: 100; background-color: transparent; border: none;">
                  <i class="bi bi-eye"></i>
                </span>
                <small class="form-text text-muted password-match-indicator" id="passwordMatchIndicator">
                 Passwords do not match so far
               </small>
              </div>
               <small class="form-text mt-1">
                <ul class="list-unstyled">
                  <li id="numeric" class="text-secondary mb-1"><i class="bi bi-circle-fill me-2" style="font-size: 0.7em;"></i>Can't be entirely numeric</li>
                  <li id="similarity" class="text-secondary mb-1 d-flex align-items-start"><i class="bi bi-circle-fill me-2" style="font-size: 0.7em;"></i><span>Includes at least one special character (e.g., ! @ # ?).</span></li>
                </ul>
              </small>
            </div>
          </div>
          {% if form.errors %}
            <div class="alert alert-danger mt-3">
              <ul>
                {% for field in form %}
                  {% for error in field.errors %}
                    <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                  {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          <div class="d-grid mt-3">
            <button type="submit" class="btn btn-primary">Sign Up</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const togglePassword1 = document.querySelector('#togglePassword1');
  const passwordInput1 = document.querySelector('#id_password1');
  const togglePassword2 = document.querySelector('#togglePassword2');
  const passwordInput2 = document.querySelector('#id_password2');
  const passwordMatchIndicator = document.querySelector('#passwordMatchIndicator');

  if (togglePassword1 && passwordInput1) {
    togglePassword1.addEventListener('click', function (e) {
      const type = passwordInput1.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput1.setAttribute('type', type);
      const icon = this.querySelector('i');
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
    });
  }

   if (togglePassword2 && passwordInput2) {
    togglePassword2.addEventListener('click', function (e) {
      const type = passwordInput2.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput2.setAttribute('type', type);
      const icon = this.querySelector('i');
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
    });
  }

  if (passwordInput1 && passwordInput2 && passwordMatchIndicator) {
      passwordInput2.addEventListener('input', validateAllPasswordFields);
      passwordInput1.addEventListener('input', validateAllPasswordFields);
  }

  function validateAllPasswordFields() {
      const password = passwordInput1.value;
      const confirmPassword = passwordInput2.value;

      // Password Match Indicator (tooltip)
      if (confirmPassword.length > 0 && password !== confirmPassword) {
          passwordMatchIndicator.classList.add('show');
      } else {
          passwordMatchIndicator.classList.remove('show');
      }

      // Password Strength (client-side relevant checks)
      const passwordIsEmpty = password.length === 0;

      const length = document.getElementById('length');
      const numeric = document.getElementById('numeric');
      const common = document.getElementById('common'); 
      const similarity = document.getElementById('similarity'); 

      // --- Length Check (under Password field) ---
      updateRequirement(length, password.length >= 8, passwordIsEmpty);

      // --- Contains uppercase and lowercase characters (under Password field) ---
      const hasUpperCase = /[A-Z]/.test(password);
      const hasLowerCase = /[a-z]/.test(password);
      updateRequirement(common, hasUpperCase && hasLowerCase, passwordIsEmpty); 

      // --- Entirely Numeric Check (under Confirm Password field) ---
      updateRequirement(numeric, password.length > 0 && !/^[0-9]+$/.test(password), passwordIsEmpty);

      // --- Includes special character (under Confirm Password field) ---
      const hasSpecialChar = /[^a-zA-Z0-9\s]/.test(password);
      updateRequirement(similarity, hasSpecialChar, passwordIsEmpty);

  }

  function updateRequirement(element, isMet, passwordIsEmpty = false) {
      const icon = element.querySelector('i');
      if (passwordIsEmpty) {
          element.classList.remove('text-success', 'text-danger');
          element.classList.add('text-secondary');
          icon.classList.remove('bi-check-circle-fill', 'bi-x-circle-fill');
          icon.classList.add('bi-circle-fill');
      } else if (isMet) {
          element.classList.remove('text-danger', 'text-secondary');
          element.classList.add('text-success');
          icon.classList.remove('bi-circle-fill', 'bi-x-circle-fill');
          icon.classList.add('bi-check-circle-fill');
      } else {
          element.classList.remove('text-success', 'text-secondary');
          element.classList.add('text-danger');
          icon.classList.remove('bi-circle-fill', 'bi-check-circle-fill');
          icon.classList.add('bi-x-circle-fill');
      }
  }

  function validateForm() {
      const password = passwordInput1.value;
      const confirmPassword = passwordInput2.value;
      if (password !== confirmPassword) {
          passwordMatchIndicator.classList.add('show');
          passwordInput2.focus();
          return false;
      }
      return true;
  }
</script>
{% endblock %}
